#!/usr/bin/env bash
set -eufm

##
# Renice the process tree recursively
# @param 1 the root process PID
##
renice-tree() {
    local parent=$1
    renice -n -20 -p "$parent" 2>/dev/null

    for child in $(ps --ppid "$parent" -o pid=); do
        renice-tree "$child"
    done
}

# Get the game to start
readonly GAME="$@"
if [[ -z "$GAME" ]]; then
    echo 'No games to run has been passed on' >&2
    exit 1
fi

# Kill all unnecessary processes
killall polybar &
killall picom &
killall conky &

# Run the game in the background
gamemoderun gamescope -W 2560 -H 1440 -w 1920 -h 1080 -r 165 -f -b -F fsr -- \
    $GAME &

# Get the task pid
readonly TASK_PID=$!

# Change the niceness of all children processes
pkexec renice-tree $TASK_PID

# Wait for all background processes
wait

# Reload bspc configuration
pkill -USR1 -x sxhkd; bspc wm -r

# Exit with the success code
exit 0
